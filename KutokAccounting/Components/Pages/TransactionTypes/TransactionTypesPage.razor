@page "/transactionTypes"
@using KutokAccounting.Components.Pages.TransactionTypes.Models
@using KutokAccounting.DataProvider.Models
@using KutokAccounting.Services.TransactionTypes.Interfaces
@using KutokAccounting.Services.TransactionTypes.Models;
@inject ITransactionTypeService TransactionTypeService
@inject IDialogService DialogService

<MudDataGrid
    @ref="_dataGrid"
    T="TransactionTypeView"
    ServerData="GetTransactionTypesAsync"
    FilterMode="DataGridFilterMode.ColumnFilterMenu">
    <ToolBarContent>
        <MudStack Style="width: 100%;">
            <MudText Typo="Typo.h6" Style="margin-top:6px;">Типи транзакцій</MudText>
            <MudStack Row="true" Justify="Justify.SpaceBetween" Style="width:100%;">
                <MudTextField
                    T="string"
                    @bind-Value="_searchString"
                    @bind-Value:after="() => _dataGrid.ReloadServerData()"
                    Placeholder="Пошук"
                    Immediate="true"
                    Adornment="Adornment.End"
                    AdornmentIcon="@Icons.Material.Filled.Search"
                    IconSize="Size.Medium"
                    Style="width:450px;">
                </MudTextField>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnAddButtonClick">
                    Додати новий тип транзакції
                </MudButton>
            </MudStack>
        </MudStack>
    </ToolBarContent>
    <Columns>
        <PropertyColumn 
            Property="tp => tp.Name" 
            Title="Назва типу транзакції" 
            Sortable="false" 
            Filterable="true"
            FilterOperators="_filterOperators"></PropertyColumn>
        <PropertyColumn 
            Property="tp => tp.Label" 
            Title="Тип" 
            Sortable="false" 
            Filterable="true" 
            FilterOperators="_filterOperators"></PropertyColumn>
        <TemplateColumn>
            <CellTemplate>
                <MudStack Row Justify="Justify.FlexEnd">
                    <MudButton Size="Size.Medium" Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="() => OnEditButtonClick(context.Item)">Редагувати
                    </MudButton>
                    <MudButton Size="Size.Medium" Variant="Variant.Filled" Color="Color.Secondary"
                               OnClick="() => OnDeleteButtonClick(context.Item)">Видалити
                    </MudButton>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="TransactionTypeView"></MudDataGridPager>
    </PagerContent>
</MudDataGrid>


@code
{
    private MudDataGrid<TransactionTypeView> _dataGrid;

    private readonly HashSet<string> _filterOperators = new()
    {
        "equals"
    };

    private int _page = 1;
    private int _pageSize = 10;

    private string? _searchString;

    private QueryParameters BuildQuery(GridState<TransactionTypeView> state)
    {
        Filters? filters = new Filters();

        ICollection<IFilterDefinition<TransactionTypeView>> filterDefinitions = state.FilterDefinitions;

        if(filterDefinitions is not null)
        {
            foreach (var filter in filterDefinitions)
            {
                if (filter.Title == "Назва типу транзакції") // nameof(filters.Name)
                    filters.Name = filter?.Value?.ToString();
                else if (filter.Title == "Тип") // nameof(filters.IsPositiveValue)
                    filters.IsPositiveValue = filter.Value is "Витрата" ? false : true;
            }
        }
        return new QueryParameters(filters, _searchString, new Pagination(){ Page = _page, PageSize = _pageSize });
    }

    private async Task<GridData<TransactionTypeView>> GetTransactionTypesAsync(GridState<TransactionTypeView> state)
    {
        using CancellationTokenSource tokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));

        string?[] filter = state.FilterDefinitions.Select(f => f?.Value?.ToString()).ToArray();

        _page += state.Page;
        _pageSize = state.PageSize;

        QueryParameters queryParameters = BuildQuery(state);

        try
        {
            PagedResult<TransactionType> pagedResult = await TransactionTypeService.GetAsync(queryParameters, tokenSource.Token);

            List<TransactionTypeView> view = pagedResult.Items.Select(tp => new TransactionTypeView
            {
                Id = tp.Id,
                Name = tp.Name,
                IsPositiveValue = tp.IsPositiveValue
            }).ToList();

            return new GridData<TransactionTypeView>
            {
                Items = view ?? new List<TransactionTypeView>(),
                TotalItems = view.Count
            };
        }
        catch (Exception)
        {
            return new GridData<TransactionTypeView>
            {
                Items = new List<TransactionTypeView>(),
                TotalItems = 0
            };
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task OnDeleteButtonClick(TransactionTypeView transactionType)
    {
        using CancellationTokenSource tokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));

        await TransactionTypeService.DeleteAsync(transactionType.Id, tokenSource.Token);

        if (_dataGrid != null)
            await _dataGrid.ReloadServerData();
    }

    private async Task OnEditButtonClick(TransactionTypeView transactionType)
    {
        DialogOptions options = new DialogOptions
        {
            FullWidth = true,
            MaxWidth = MaxWidth.Medium,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        DialogParameters<EditTransactionTypeDialog> parameters = new DialogParameters<EditTransactionTypeDialog> { { d => d.TransactionTypeView, transactionType } };

        IDialogReference dialog = await DialogService.ShowAsync<EditTransactionTypeDialog>("Редагувати тип транзакції", parameters, options);

        DialogResult? result = await dialog.Result;

        if (_dataGrid != null && !result.Canceled)
            await _dataGrid.ReloadServerData();
    }

    private async Task OnAddButtonClick()
    {
        DialogOptions options = new DialogOptions
        {
            FullWidth = true,
            MaxWidth = MaxWidth.Medium,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        IDialogReference dialog = await DialogService.ShowAsync<AddTransactionTypeDialog>("Додати новий тип транзакції", options);

        DialogResult? result = await dialog.Result;

        if (_dataGrid != null && !result.Canceled)
            await _dataGrid.ReloadServerData();
    }
}
